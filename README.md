Description
===========

lambda-ftp-collector was a learning exercise, an occasion for myself to learn Lambda and NodeJs.
It is composed of a set of AWS Lambda functions that collect files via FTP into an AWS S3 bucket.


Origin of the project
=====================

A large number of IT projects I have been involved with starts by collecting a set of files from a customer, on a regular basis or as a one off. Often via SFTP, more rarely via FTP.
Amazon provides some good tools for ingesting data (Kinesis), but it assumes that the data is being sent and not collected.

I wanted to create a set of tool easily configurable to collect files via FTP / SFTP.
It is also a pretext for me to experiment with Lambda and NodeJS.

Requirements:
================================

* Download files matching a file mask from a (S)FTP server into a S3 Bucket
* Handle large number of files (tens of thousands)
* Be reliable (retry when server is not available)


Why has the project been stopped
================================

In retrospect, the use case I picked, (S)FTP file download, is not really suited for Lambda.
Lambda offer very little control on its concurrency and this quickly became a problem. When dealing with large number of files, too many connections would be open, flooding the (S)FTP server.

Only the FTP transfer has been coded, no SFTP.


Architecture
===========
The ftpLister function takes a path, a file mask a bucket name and a sourceId to reference FTP address and credentials as paramteres.
It will list all the files matching the mask and write an entry in a DynamoDb table for each of them.

The ftpTransferer get triggered by the DynamoDb events. The function takes a path, a file name, a bucket name and a sourceId to reference FTP address and credentials as paramteres.
It will download the file and upload it or stream it to the s3 bucket. Files are downloaded to /tmp and uploaded to S3 if less than 50Mb, they are streamed directly to the bucket if larger.


FTP server credentials
======================

FTP server addresses and credentials have to be sotred within the functions environment variables (which are encrypted by Amazon).
Three variables environment variables are required to configure one transfer:

<TRANSFER_ID>_FTP_SERVER

<TRANSFER_ID>_FTP_USER

<TRANSFER_ID>_PASSWORD

E.G.:
```
TRANSFER_01_FTP_SERVER=ftp.example.com
TRANSFER_01_FTP_USER=user01
TRANSFER_01_PASSWORD=Aasdjp2013019743nljj
```

The Tranfer Id (here TRANSFER_01) can be used to call the API

API
===

Event
------
* path - _string_ - the remote path of files to be collected
* mask - _string_ - Regular expression - only filenames matching the expression will be collected
* sourceId - _string_ - FTP Credential ID, have to match configured environment variables
* dest - _object_ - with the following properties:
  * type - _string_ - only s3 supported for now
  * bucketName - _string_ - S3 bucket to which the files will be downloaded to



  Sample
  ------
  ```
  {
    "path": "/tmp/test",
    "mask": ".*\\.txt",
    "sourceId": "TRANSFER_01",
    "dest": {
          "type":  "s3",
          "bucketName":  "ogob-la mbda-test"
        }

  }
  ```

Output
------
* files - _array_ - array of objects with the following properties
  * fileName - _string_
  * size - _number_ - In Bytes
  * status - _string_ - with one of the following
    * s3 - The file has been succesfully downloaded to S3
    * ftp_error - An error occured when downloading the file
    * s3_error - The file could be downloaded but an error occured while uploading it to s3
  * error - _string_ - error short description
  * bucketName - _string_ - S3 bucket to where the file is stored


Testing and Deployment
======================
I strongly recommend to use node-lamba

```
npm install -g node-lambda
node-lambda setup
node-lambda -f deploy.env run
node-lambda -f deploy.env deploy
```

Place your environment variables in deploy.env for each functions:
Example
```
TRANSFER_01_FTP_SERVER=ftp.example.com
TRANSFER_01_FTP_USER=user01
TRANSFER_01_PASSWORD=Aasdjp2013019743nljj

TRANSFER_02_FTP_SERVER=ftp.example.com
TRANSFER_02_FTP_USER=user02
TRANSFER_02_PASSWORD=Aasdjp2013019743nljj
```

Configure the .env generated by node-lamda:
```
AWS_ENVIRONMENT=development
AWS_ACCESS_KEY_ID=XXXXXXXXXXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
AWS_PROFILE=
AWS_SESSION_TOKEN=
AWS_ROLE_ARN=arn:aws:iam::xxxxxxxxxxxx:role/lambdaNewRole
AWS_REGION=us-east-1
AWS_FUNCTION_NAME=ftpLister
AWS_HANDLER=index.handler
AWS_MEMORY_SIZE=128
AWS_TIMEOUT=150
AWS_DESCRIPTION=
AWS_RUNTIME=nodejs4.3
AWS_VPC_SUBNETS=
AWS_VPC_SECURITY_GROUPS=
EXCLUDE_GLOBS="event.json"
PACKAGE_DIRECTORY=build
```
